---
name: Propagate renv.lock

on:
  # pull_request:
  #   types:
  #     - opened
  #     - synchronize
  #     - reopened
  #     - ready_for_review
  #   branches:
  #     - main
  #     - devel
  #     - pre-release
  push:
    branches:
      - 2_use_common_renv_lock

jobs:
  renv:
    name: Propagate renv.lock
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        repos:
          # - pharmaverse/admiralonco
          # - pharmaverse/admiraldev
          # - pharmaverse/admiraltemplate
          # - pharmaverse/admiralophtha
          # - pharmaverse/admiral
          - pharmaverse/admiral.test

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check if renv.lock changed
        id: changed-files-specific
        uses: tj-actions/changed-files@v29.0.4
        with:
          # later change to 'renv.lock'
          files: |
            renv.lock.test

      - name: Test
        if: steps.changed-files-specific.outputs.any_changed == 'true'
        run: |
          echo "${{ matrix.repos }}"
          cat renv.lock.test

      - name: Checkout extension repo
        if: steps.changed-files-specific.outputs.any_changed == 'true'
        uses: actions/checkout@v3
        with:
          repository: ${{ matrix.repos }}
          path: './repo'

      - name: Run script
        if: steps.changed-files-specific.outputs.any_changed == 'true'
        run: |
          cd repo && git status
          git checkout automated-renv-lock-propagation || git checkout -b automated-renv-lock-propagation
          cp ../renv.lock.test .
          git add renv.lock.test
          git diff --cached
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"
          git commit -m "Update renv.lock" || true

      - name: Push badges
        if: steps.changed-files-specific.outputs.any_changed == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: automated-renv-lock-propagation
          directory: repo
          repository: ${{ matrix.repos }}
